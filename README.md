# Architecture

![archi](ce-vin-ci.png?raw=true "Architecture")

# OVH :

[OVH](https://www.ovh.com/manager/#/domain) est le DNS provider.

TODO Il faudra connecter deux noms de domaines aux applications Firebase :
* [ce-vin-ci.fr](https://www.ovh.com/manager/web/#/configuration/domain/ce-vin-ci.fr/information) avec sous-domaine quizz.ce-vin-ci.fr
* [ce-vin-ci.com](https://www.ovh.com/manager/web/#/configuration/domain/ce-vin-ci.com/information) avec sous-domaine quizz.ce-vin-ci.com

Les deux domaines pointent vers le même projet ce-vin-ci. Les deux sous-domaines pointent vers le même projet ce-vin-ci-quizz.

[https://firebase.google.com/docs/hosting/custom-domain](https://firebase.google.com/docs/hosting/custom-domain)

# FIREBASE :

[Un "projet"](https://console.firebase.google.com/project/ce-vin-ci/overview) | [Hosting](https://console.firebase.google.com/project/ce-vin-ci/hosting/sites)

Deux "sites" :
* [ce-vinc-ci](https://console.firebase.google.com/project/ce-vin-ci/hosting/sites/ce-vin-ci)
* [ce-vin-ci-quizz](https://console.firebase.google.com/project/ce-vin-ci/hosting/sites/ce-vin-ci-quizz)

## ce-vinc-ci site statique

GatsbyJS PWA pour la partie front, blog. 

[sources](https://github.com/ce-vin-ci/ce-vin-ci-static)

[https://ce-vin-ci.web.app/](https://ce-vin-ci.web.app/)

## quizz.ce-vin-ci SPA

ReactJS PWA pour la partie quizz

[sources](https://github.com/ce-vin-ci/ce-vin-ci-quizz)

[https://ce-vin-ci-quizz.web.app/](https://ce-vin-ci-quizz.web.app/)

# HEROKU

[Admin Heroku apps/ce-vin-ci-cms](https://dashboard.heroku.com/apps/ce-vin-ci-cms)

## Strapi

*Attention* : peut être lent à répondre (heroku free plan) "your app is put to sleep after 30 minutes of inactivity. This does not mean your app will be dead after 30 minutes—it just means your app will take some time (around 5–10 seconds) to wake up"

[Admin du CMS](https://ce-vin-ci-cms.herokuapp.com/admin/auth/login)

Le CMS qui tourne sur Heroku est Strapi

Types de contenus :

![strapi_content_types](strapi_content_types.png?raw=true "Strapi Content types")

# MongoDB Atlas

512Mo gratuits

[base NoSQL utlisée par le CMS Strapi](https://cloud.mongodb.com/v2/5fd600602e794047d3227878#clusters)

[doc Strapi pour MongoDB](https://strapi.io/documentation/developer-docs/latest/guides/databases.html#mongodb-installation)

# Continuous Deployment 

* redéployer suite à un push sur Github (classique)

[Github actions](https://github.com/ce-vin-ci/ce-vin-ci-quizz/blob/main/.github/workflows/firebase-hosting-merge.yml)

TODO : pourquoi on ne précise pas le site ?

```
# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools 

name: Deploy to Firebase Hosting on merge
'on':
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: install
        run: npm install
      - name: build
        run: npm run build
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_CE_VIN_CI }}'
          channelId: live
          projectId: ce-vin-ci
        env:
          FIREBASE_CLI_PREVIEWS: hostingchannels
```

# Déploiement suite à contribution CMS

* redéployer le site statique suite à une modification de contenu dans le CMS. (Cf [JAMStack](https://jamstack.wtf/))

![maj_cms](ce-vin-ci_contrib-cd.png?raw=true "Maj CMS")

```
curl -H "Authorization: token <YOUR_GITHUB_TOKEN>" \
    --request POST \
    --data '{"event_type": "<YOUR_EVENT_TYPE>"}' \
    https://api.github.com/repos/<YOUR_GITHUB_USER>/<YOUR_GITHUB_REPO>/dispatches
```

# TODO utiliser Keycloak comme authentication provider pour Strapi

Pour modifier du contenu, aujourd'hui il faut se connecter à l'admin Strapi.

Projet : Créer un client d'admin qui permettra d'écrire (créer, modifier) du contenu de CMS.

_Ce client devra obtenir un JWT auprès de keycloak au nom de l'utilisateur (Oauth2)_

[user-permissions plugin](https://strapi.io/documentation/developer-docs/latest/plugins/users-permissions.html#concept)

"This plugin provides a way to protect your API with a full authentication process based on JWT. This plugin comes also with an ACL strategy that allows you to manage the permissions between the groups of users."

https://github.com/strapi/strapi/issues/3072

https://strapi.io/documentation/developer-docs/latest/plugins/users-permissions.html#concept

# notes diverses

firebase : projet "bulle étanche", avec dedans des applis (= site pour un projet web).

cloudinary pour les files upload, hébergement d'images

page facebook !!!

google analytics

entête OGP <head> HTML ! pour twitter ou facebook qui alimentent des vignettes dans les tweets

## Mailing

existe entête DNS pour les mails pour rediriger contact@vin.fr pour rediriger vers a.vergnaud@gmail.com

https://docs.ovh.com/fr/emails/guide-des-redirections-emails/

elasticmail : 
pas un client smtp
code pour envoyer un email : dans elastic mail donne un entete, elastic offre api REST
si on veut un webmail : plus cher

## PWA

workbox cli scanne les static et les ajoute dans le service js pour avoir tout en offline

